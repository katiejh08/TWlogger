---
title: "Analyze Final HMM"
author: "Katie Harrington"
date: "April 19, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Get Started
*This file takes ... and does ...

## Load libraries; set working directory and local time zone offset
```{r echo=FALSE,warning=FALSE}
library(tidyverse)
library(dplyr)
library(maptools) # to calculate solarpos
library(stringr)
library(lubridate)
library(adehabitatLT)
#library(argosfilter)
library(geosphere)
library(ggpubr)
library(sp)
library(rgdal)
library(tibble)
library("rnaturalearth")
library("rnaturalearthdata")
library("sf")
library("ggspatial")
library(marmap)
library(mapdata)
library(metR)
library(RcppRoll)

setwd("~/Projects/R/TWlogger")
tzOffset <-"Etc/GMT+3"
```

# Pre Process Data

## Import HMM data
```{r}
# Load R workspace
load("~/Projects/R/TWlogger/data_with_states.RData")
# Combine list into one dataframe
data <-bind_rows(data_with_states)
rm(data_with_states)
# Create Spatial Points
data$long <- -60.09
data$lat <- -51.37

# Check dttz 
attr(data$dttz, "tzone") #Check tz
attr(data$dttz, "tzone") <- tzOffset

data$date <- as.Date(data$dttz, tz = tzOffset)

# Run the sunrise sunset script
source('SunriseSunsetTimes.r')
# Check for NAs
sapply(data, function(x) sum(is.na(x)))
# Determine Season (calculated from 2018 solstices and equinoxes)
data$yday <- yday(data$dttz)
data$season <- rep('NA')
#data[which(data$yday > 79 & data$yday <= 173),]$season <- 'Fall'
data[which(data$yday > 173 & data$yday <= 265),]$season <- 'Winter'
#data[which(data$yday > 265 & data$yday < 355),]$season <- 'Spring'
data[which(data$yday >= 355 | data$yday <= 79),]$season <- 'Summer'
data$season <- as.factor(data$season)
unique(data$season)

# Rename data
data_states <-data
rm(data)
```

## Import Raw Acc, combine with HMM states data, and calculate ODBA
*This creates one file with states and raw acc. Saved as data_states.RData, so do not need to run this pre process more than once.
```{r}
# load Final Metrics from AnalyzeFinalAccV1
load("~/Projects/R/TWlogger/FinalMetrics.RData")
# Add acc data to stateData
data_states <- left_join(data_states,dplyr::select(data,ID,dttz,Ax,Ay,Az), by = c("ID","dttz"))
rm(data)
# Consolidate astronomical periods two periods (day and night)
data_states <- data_states %>% 
  group_by(season, ID) %>% 
  mutate(dayNight = ifelse(astronomical %in% c("dawn","day","dusk"),"day","night")) %>%
  ungroup
# Check for NAs
sapply(data_states, function(x) sum(is.na(x)))

# Create SolarMidnight based hourly bins
data_states$solarMidnight <- hms::as.hms((data_states$solarnoon- dhours(12)),tz = tzOffset)
data_states$time <- hms::as.hms(data_states$dttz,tz = tzOffset)
data_states$timeBin <- floor(as.numeric(difftime(data_states$time, data_states$solarMidnight,units = "hours")))
data_states$timeBin <- ifelse(data_states$timeBin < 0,data_states$timeBin+24,data_states$timeBin)
data_states$hr <- hour(data_states$dttz)
data_states$night <- NULL

# Recalculate ODBA
# Calculate static (running mean)
windowSize=11 
data_states <- data_states %>% 
  arrange(ID,dttz) %>% 
  group_by(ID) %>% 
  mutate(static_Ax=roll_mean(Ax,windowSize,fill=NA),
         static_Ay=roll_mean(Ay,windowSize,fill=NA),
         static_Az=roll_mean(Az,windowSize,fill=NA)) %>%
  ungroup

### THIS NEEDS LOVE- only replaces the first and last set of NA's. What about the others!
#arrange, split by ID, add depDay (will be either 1st or 2nd day of deployment), filter by depDay, 

# Replace the NA's at the beginning with the first good value
data_states <- data_states %>%
  arrange(ID,dttz) %>%
  group_by(ID) %>%
  mutate(naUp = ifelse(row_number()<=(windowSize-1)/2+1,1,0),
         naDown = ifelse(row_number() > n() - ((windowSize-1)/2+1),1,0)) %>%# View
  ungroup %>% 
  group_by(ID,naUp) %>% 
  mutate(static_Ax = ifelse(naUp == 1,last(static_Ax),static_Ax),
         static_Ay = ifelse(naUp == 1,last(static_Ay),static_Ay),
         static_Az = ifelse(naUp == 1,last(static_Az),static_Az)) %>% 
  ungroup %>% 
  group_by(ID,naDown) %>% 
  mutate(static_Ax = ifelse(naDown == 1,first(static_Ax),static_Ax),
         static_Ay = ifelse(naDown == 1,first(static_Ay),static_Ay),
         static_Az = ifelse(naDown == 1,first(static_Az),static_Az)) %>% 
  ungroup
data_states$naUp <- NULL
data_states$naDown <- NULL

# Calculate dynamic (raw-static) and ODBA (sum abs dynamic)
data_states <- data_states %>%
  arrange(ID,dttz) %>%
  group_by(ID) %>% 
  mutate(dyn_Ax=Ax-static_Ax,
         dyn_Ay=Ay-static_Ay,
         dyn_Az=Az-static_Az,
         ODBA=abs(dyn_Ax+dyn_Ay+dyn_Az)) %>% 
  ungroup #%>% View

data_states$state <-ifelse(data_states$state_classif==1|data_states$state_classif==2,"Rest","Active")
save(data_states,file="data_states.RData")
```

# Process Data

## States
### Calculate State Proportions per 24hr cycle
*No longer running this script
*Creates stateSummaryIND24
```{r}
# # Calculate state proportions per 24 hour cycle
# stateSummaryIND24 <- data_states %>% 
#   group_by(season, ID) %>%
#   mutate(cycleLength = n()) %>% #View
#   ungroup %>% 
#   group_by(season, ID, state_classif,cycleLength) %>% 
#   summarize(stateCountCycle = n()) %>% 
#   mutate(statePropCycle = stateCountCycle/cycleLength) %>% 
#   ungroup
# stateSummaryIND24$season_state <- paste(stateSummaryIND24$season,
#                                         stateSummaryIND24$state_classif,sep="_")
```

### Plot state proportions per 24hr cycle
*No longer running this script
```{r}
Pcycle <- stateSummaryIND24 %>% 
  group_by(season) %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = statePropCycle, group = season_state, color = season)) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (24hr Cycle)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pcycle
```

### Calculate state proportions per individual by astronomical period
*No longer creating these plots because Dawn+Day+Dusk have been combined
*Creates stateSummaryIND
```{r}
# Calculate state proportions with 4 periods (dawn, day, dusk, night)
stateSummaryIND <- data_states %>% 
  group_by(season, ID, astronomical) %>% 
  mutate(periodLength = n()) %>% 
  ungroup %>% 
  group_by(season, ID, astronomical, state_classif,periodLength) %>% 
  summarize(stateCount = n()) %>% 
  mutate(stateProp = stateCount/periodLength) %>% 
  ungroup
# Change classes for plotting
stateSummaryIND$ID <- as.factor(stateSummaryIND$ID)
stateSummaryIND$astronomical <- as.factor(stateSummaryIND$astronomical)
str(stateSummaryIND) # Check classes
# Create vectors to retain groupings for plots
stateSummaryIND$season_per_state <- paste(stateSummaryIND$season,
                                          stateSummaryIND$astronomical,
                                          stateSummaryIND$state_classif,sep="_")
stateSummaryIND$season_period <- paste(stateSummaryIND$season,
                                          stateSummaryIND$astronomical,sep="_")
```

### Calculate 4-state proportions by 2 periods (day and night)
*Creates stateSummaryIND2period
*Statistical test of seasonal differences in daytime durations of state 3 and state 4

```{r}
# Calculate 4-state proportions for by 2 periods
stateSummaryIND2period <- data_states %>% 
  group_by(season, ID) %>% 
  mutate(dayNight = ifelse(astronomical %in% c("dawn","day","dusk"),"day","night")) %>%
  ungroup %>% 
  group_by(season, ID, dayNight) %>% 
  mutate(periodLength2 = n()) %>%
  ungroup %>% 
  group_by(season, ID, dayNight, state_classif,periodLength2) %>% 
  summarize(stateCount2 = n()) %>% 
  mutate(stateCountMin = stateCount2/60,
         stateCountHour = stateCount2/60/60,
         stateProp2 = stateCount2/periodLength2) %>% 
  ungroup

# Create vectors to retain groupings for plots
stateSummaryIND2period$ID <- as.factor(stateSummaryIND2period$ID)
stateSummaryIND2period$dayNight <- as.factor(stateSummaryIND2period$dayNight)
stateSummaryIND2period$season_per_state <- paste(stateSummaryIND2period$season,
                                          stateSummaryIND2period$dayNight,
                                          stateSummaryIND2period$state_classif,sep="_")
stateSummaryIND2period$season_period <- paste(stateSummaryIND2period$season,
                                       stateSummaryIND2period$dayNight,sep="_")

# Statistical test of seasonal differences in daytime state 3
stateSummaryIND2period$state_classif <- as.factor(stateSummaryIND2period$state_classif)
daytimeState3 <- stateSummaryIND2period %>% 
  group_by(season,ID,dayNight,state_classif,stateCountHour) %>%
  filter(dayNight=="day",
         state_classif=="3") %>%
  ungroup

shapiro.test(daytimeState3$stateCountHour)
t.test(stateCountHour ~ season, data = daytimeState3, var.equal = TRUE)
wilcox.test(stateCountHour ~ season, data = daytimeState3, var.equal = TRUE)

# Statistical test of seasonal differences in daytime state 4
daytimeState4 <- stateSummaryIND2period %>% 
  group_by(season,ID,dayNight,state_classif,stateCountHour) %>%
  filter(dayNight=="day",
         state_classif=="4") %>%
  ungroup

shapiro.test(daytimeState4$stateCountHour) # p-value = 0.05814
t.test(stateCountHour ~ season, data = daytimeState4, var.equal = TRUE)
wilcox.test(stateCountHour ~ season, data = daytimeState4, var.equal = TRUE)
```

### Calculate daytime 2-state proportions by 2 periods (day and night)
*Creates stateSummaryIND2period2state
*Statistical test of seasonal differences in daytime active state
```{r}
# Calculate daytime 2-state proportions
stateSummaryIND2period2state <- stateSummaryIND2period %>% 
  group_by(season,ID,dayNight,state_classif) %>%
  # filter(dayNight=="day") %>% 
  mutate(state = ifelse(state_classif %in% c("1","2"),"rest","active")) %>%
  ungroup %>% 
  group_by(season, ID, dayNight,state,periodLength2) %>% 
  # mutate(periodLength2 = n()) %>% 
  # ungroup %>% 
  # group_by(season, ID, dayNight, state_classif,periodLength2) %>% 
  summarize(stateCount2state = sum(stateCount2)) %>% 
  mutate(stateCountMin = stateCount2state/60,
         stateCountHour = stateCount2state/60/60,
         stateProp2 = stateCount2state/periodLength2) %>% 
  ungroup

#Statistical test of seasonal differences in daytime active state
daytimeActiveSU <- stateSummaryIND2period2state %>% 
  group_by(season,ID,dayNight,state) %>%
  filter(season=="Summer",
         dayNight=="day",
         state=="active") 
daytimeActiveWI <- stateSummaryIND2period2state %>% 
  group_by(season,ID,dayNight,state) %>%
  filter(season=="Winter",
         dayNight=="day",
         state=="active") 
shapiro.test(daytimeActiveSU$stateCountHour)
shapiro.test(daytimeActiveWI$stateCountHour)
test <- stats::t.test(daytimeActiveSU$stateCountHour,daytimeActiveWI$stateCountHour)
test

```

### Calculate seasonal state durations (bout length) by 2 periods (day+night)
*Includes state bout length, combined states (active and rest), and combined periods (day and night)
*Creates stateBout & stateBoutSummary

```{r}
stateBout <- data_states %>% 
  group_by(season,ID) %>% 
  arrange(dttz) %>%
  mutate(boutNum = cumsum(replace_na(lag(state_classif) != state_classif, 1))) %>%
  ungroup %>% 
  group_by(season,ID,boutNum) %>% 
  mutate(boutLength = n()/60/60) %>% #bout length is in minutes
  ungroup
stateBout$state_classif <- as.factor(stateBout$state_classif)
stateBout$state <- ifelse(stateBout$state_classif==1|stateBout$state_classif==2,
                             "rest","active")
stateBout$hr <- hour(stateBout$dttz)
stateBout$hr <- as.factor(stateBout$hr)

# Create SolarMidnight based hourly bins
stateBout$solarMidnight <- hms::as.hms((stateBout$solarnoon- dhours(12)),tz = tzOffset)
stateBout$time <- hms::as.hms(stateBout$dttz,tz = tzOffset)
stateBout$timeBin <- floor(as.numeric(difftime(stateBout$time, stateBout$solarMidnight,units = "hours")))
stateBout$timeBin <- ifelse(stateBout$timeBin < 0,stateBout$timeBin+24,stateBout$timeBin)
stateBout$timeBin <- as.factor(stateBout$timeBin)

# Calculate bout length
stateBoutSummary <- stateBout %>%
  group_by(season,ID,boutNum,state_classif,dayNight,timeBin,state) %>%
  summarize(boutLength=first(boutLength)) %>%
  ungroup
```

### Plot 4-state proportions by astronomical period
*This creates stacked plots by Dawn, Day, Dusk, and Night
*No longer creating these plots because Dawn+Day+Dusk have been combined
```{r}
# Plot dawn
Pdawn <- stateSummaryIND %>% 
  group_by(season,astronomical) %>% 
  filter(astronomical == "dawn") %>% #View
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateProp, 
                   group = season_per_state, color = season)) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (Dawn)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pdawn
# Plot day
Pday <- stateSummaryIND %>% 
  group_by(season,astronomical) %>% 
  filter(astronomical == "day") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateProp, 
                   group = season_per_state, color = season)) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (Day)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pday
# Plot dusk
Pdusk <- stateSummaryIND %>% 
  group_by(season,astronomical) %>% 
  filter(astronomical == "dusk") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateProp, 
                   group = season_per_state, color = season)) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (Dusk)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pdusk
# Plot night
Pnight <- stateSummaryIND %>% 
  group_by(season,astronomical) %>% 
  filter(astronomical == "night") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateProp, 
                   group = season_per_state, color = season)) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (Night)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pnight

# Stack plots to compare full cycle
PallPeriods <- ggarrange(Pdawn,Pday,Pdusk,Pnight,nrow=2,ncol=2)
PallPeriods

# Save a file at 300 ppi
ggsave(PallPeriods, file="Seasonal State Proportions by Period.png",width=12, height=6, dpi=300)
```

### Plot 4-state proportions by period (day and night)
```{r}
# Plot combined day
Pday2 <- stateSummaryIND2period %>% 
  group_by(season,dayNight) %>% 
  filter(dayNight == "day") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateProp2, 
                   group = season_per_state, color = season)) +
  ylim(0,1) +
  labs(x="State",
       y = "Proportion (%)",
       title = "Seasonal daytime state proportions") + 
  scale_x_discrete(limits=c("Rest", "Rest with Noise", "Low Activity", "High Activity")) +
  theme_classic(base_size = 13) +
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pday2
# Save a file at 300 ppi
ggsave(Pday2, file="Seasonal daytime 4-state proportions.png",width=12, height=6, dpi=300)
# Plot night
Pnight2 <- stateSummaryIND2period %>% 
  group_by(season,dayNight) %>% 
  filter(dayNight == "night") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateProp2, 
                   group = season_per_state, color = season)) +
  ylim(0,1) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (Night)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pnight2

# Stack plots to compare full cycle
P2Periods <- ggarrange(Pday2,Pnight2,nrow=2)
P2Periods

# Save a file at 300 ppi
ggsave(P2Periods, file="Seasonal State Proportions by Two Periods.png",width=12, height=6, dpi=300)
```

### Plot 4-state absolute durations by period (day and night)
*Creates "Seasonal State Durations by Two Periods"
```{r}
# Plot day
PdayDur <- stateSummaryIND2period %>%# View
  group_by(season,dayNight) %>% 
  filter(dayNight == "day") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateCountHour, 
                   group = season_per_state, color = season)) +
  scale_color_discrete(name = "Season") +
  scale_y_continuous(breaks = seq(0, 24, by = 2)) +
  labs(x="State",
       y = "Duration (hr)",
       title = "Seasonal daytime state durations") + 
  scale_x_discrete(limits=c("Rest", "Rest with Noise", "Low Activity", "High Activity")) +
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PdayDur
ggsave(PdayDur, file="Seasonal daytime absolute 4-state durations.png",width=12, height=8, dpi=300)

# Plot night
PnightDur <- stateSummaryIND2period %>% #View
  group_by(season,dayNight) %>% 
  filter(dayNight == "night") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateCountHour, 
                   group = season_per_state, color = season)) +
  scale_color_discrete(name = "Season") +
  scale_y_continuous(breaks = seq(0, 24, by = 2)) +
  labs(x="State",
       y = "Duration (hr)",
       title = "Seasonal nighttime state durations per individual (night)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PnightDur

# Stack plots to compare full cycle
PcycleDur <- ggarrange(PdayDur,PnightDur,nrow=2)
PcycleDur

# Save a file at 300 ppi
ggsave(PcycleDur, file="Seasonal State Durations by Two Periods.png",width=8, height=8, dpi=300)
```

### Plot seasonal 2-state (active and rest) daytime proportions
*Seasonal state proportions per 24-hr cycle
```{r}
stateSummaryIND2period2state
PstatePropd <- stateSummaryIND2period2state %>%
  ggplot() +
  geom_boxplot(aes(x = state, y = stateProp2, color = season)) +
  labs(x="State",
       y = "Proportion (%)",
       title = "Seasonal daytime state proportions") + 
  theme_classic(base_size = 13) + 
  scale_color_discrete(name = "Season") +
  ylim(0,1) +
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PstatePropd
# Save a file at 300 ppi
ggsave(PstatePropd, file="Seasonal daytime state proportions.png",width=8, height=8, dpi=300)
```


### Plot seasonal 2-state (active and rest) absolute durations by period (day and night)
*Creates "Seasonal absolute 2-state durations by period"
*Creates "Seasonal daytime absolute 2-state durations"
```{r}
#Calculate total state durations per day
stateDur2period <- stateBoutSummary %>%# View
  group_by(ID, season, dayNight,state) %>% 
  summarize(boutTotal = sum(boutLength)) 

PstateDurSU <- stateDur2period %>% 
  filter(season=="Summer") %>%
  ggplot() +
  geom_boxplot(aes(x = dayNight, y = boutTotal, color = state)) +
  labs(x="Period",
       y = "Duration (hr)",
       title = "Austral summer absolute state durations by period") + 
  theme_classic(base_size = 13) + 
  scale_color_discrete(name = "State") +
  scale_y_continuous(limits=c(0,24),breaks = seq(0, 24, by = 2)) +
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PstateDurSU

# Plot winter states (active and rest) by combined period (day and night)
PstateDurWI <- stateDur2period %>% 
  filter(season=="Winter") %>%
  ggplot() +
  geom_boxplot(aes(x = dayNight, y = boutTotal, color = state)) +
  labs(x="Period",
       y = "Duration (hr)",
       title = "Austral winter absolute state durations by period") + 
  theme_classic(base_size = 13) +
  scale_color_discrete(name = "State") +
  scale_y_continuous(limits=c(0,24),breaks = seq(0, 24, by = 2)) +
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PstateDurWI
# Stack plots to compare full cycle
PstateDur24hr <- ggarrange(PstateDurSU,PstateDurWI,nrow=2)
PstateDur24hr

# Save a file at 300 ppi
ggsave(PstateDur24hr, file = "Seasonal absolute 2-state durations by period.png",width=8, height=8, dpi=300)

PstateDurd <- stateDur2period %>% 
  filter(dayNight=="day") %>% 
  ggplot() +
  geom_boxplot(aes(x = state, y = boutTotal, color = season)) +
  labs(x="State",
       y = "Duration (hr)",
       title = "Seasonal daytime absolute state durations") + 
  theme_classic(base_size = 13) + 
  scale_color_discrete(name = "State") +
  scale_y_continuous(limits=c(0,24),breaks = seq(0, 24, by = 2)) +
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PstateDurd
# Save a file at 300 ppi
ggsave(PstateDurd, file="Seasonal daytime absolute 2-state durations.png",width=8, height=8, dpi=300)
```


### Plots to compare state proportion and absolute durations per period
```{r}
# Stack plots to compare seasonal 4-state proportion and absolute duration by day and night
PpropDur4state <-ggarrange(PdayDur,PnightDur,Pday2,Pnight2,nrow=2,ncol=2)
PpropDur4state
# Save a file at 300 ppi
ggsave(PpropDur, file="Compare State Proportion and Duration.png",width=12, height=6, dpi=300)

# Stack plots to compare seasonal 2-state proportion and absolute duration by day and night
# Still need to change the plots included in this
PpropDur2state <-ggarrange(PstateDurd,PstatePropd,ncol=2)
PpropDur2state
# Save a file at 300 ppi
ggsave(PpropDur2state, file="Seasonal daytime state duration and proportion.png",width=12, height=6, dpi=300)
```


### Statistical test to compare state proportions and absolute durations per period
```{r}
# Test for difference in state duration between summer and winter day
# This subsets by day/night and filters for season, day, and state 4.
seasdiffdur1 <- stateSummaryIND2period %>% 
  subset(.,select = c(season,dayNight,state_classif,stateCountHour)) %>%
  filter(dayNight == "day",
         season == "Winter",
         state_classif == "4")
  # spread(season,stateCountHour)
seasdiffdur1$stateCountHourWI <- seasdiffdur1$stateCountHour
seasdiffdur1$stateCountHour <- NULL
seasdiffdur2 <- stateSummaryIND2period %>% 
  subset(.,select = c(season,dayNight,state_classif,stateCountHour)) %>%
  filter(dayNight == "day",
         season == "Summer",
         state_classif == "4")
  # spread(season,stateCountHour) 
seasdiffdur2$stateCountHourSU <- seasdiffdur2$stateCountHour
seasdiffdur2$stateCountHour <- NULL
shapiro.test(seasdiffdur1$stateCountHourWI)
shapiro.test(seasdiffdur2$stateCountHourSU)
test <- stats::t.test(seasdiffdur1$stateCountHourWI,seasdiffdur2$stateCountHourSU)
test

seasdiffdurState4 <- cbind(seasdiffdur1$stateCountHourWI,seasdiffdur2$stateCountHourSU)
colnames(seasdiffdurState4) <- c("stateCountHourWI", "stateCountHourSU")
write_csv(as.data.frame(seasdiffdurState4),file.path(getwd(),"state4duration.csv"))
```

## ODBA
## Statistical test of differences in total odba per year to confirm year pooling
```{r}
# Test for differences in summer years
data_states$yr <- year(data_states$dttz)
sumODBApool <- data_states %>% 
  group_by(ID,yr,season) %>% 
  summarize(sumODBA=sum(ODBA))

sumODBApoolSU17 <- sumODBApool %>% 
  filter(season == "Summer",
         yr == "2017")
sumODBApoolSU19 <- sumODBApool %>% 
  filter(season == "Summer",
         yr == "2019")
shapiro.test(sumODBApoolSU17$sumODBA)
shapiro.test(sumODBApoolSU19$sumODBA)
test <- stats::t.test(sumODBApoolSU17$sumODBA,sumODBApoolSU19$sumODBA)
test
# Test for differences in winter years
sumODBApoolWI17 <- sumODBApool %>% 
  filter(season == "Winter",
         yr == "2017")
sumODBApoolWI18 <- sumODBApool %>% 
  filter(season == "Winter",
         yr == "2018")
shapiro.test(sumODBApoolWI17$sumODBA)
shapiro.test(sumODBApoolWI18$sumODBA)
test <- stats::t.test(sumODBApoolWI17$sumODBA,sumODBApoolWI18$sumODBA)
test
```

### Plot ODBA
*Seasonal total ODBA per solar hour with trendline
*Seasonal mean ODBA per solar hour with trendline
```{r}
# Meanline summer
meanlineSU <- data_states %>%
  filter(season == "Summer") %>% #View
  group_by(ID, timeBin) %>%
  summarize(odbaGSum = sum(ODBA/9.81,na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(timeBin) %>% 
  summarize(meanODBA = mean(odbaGSum))
meanlineWI <- data_states %>%
  filter(season == "Winter") %>% #View
  group_by(ID, timeBin) %>%
  summarize(odbaGSum = sum(ODBA/9.81,na.rm = TRUE)) %>% 
  ungroup() %>% 
  group_by(timeBin) %>% 
  summarize(meanODBA = mean(odbaGSum))

# Seasonal total ODBA per solar hour
PodbaSum24Su <- data_states %>%
  filter(season == "Summer") %>% #View
  group_by(ID, timeBin) %>%
  summarize(odbaGSum = sum(ODBA/9.81,na.rm = TRUE)) %>% 
  ggplot() +
  geom_line(aes(x=timeBin, y=odbaGSum, group=ID,color=ID)) +
  geom_line(data=meanlineSU,aes(x=timeBin, y=meanODBA),color="black",size=1.5) +
  ylim(0,800) +
  labs(x="Solar Hour",
       y = "Total ODBA (g)",
       title = "Austral summer total ODBA per solar hour") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PodbaSum24Su
PodbaSum24Wi <- data_states %>%
  filter(season == "Winter") %>% #View
  group_by(ID, timeBin) %>%
  summarize(odbaGSum = sum(ODBA/9.81,na.rm = TRUE)) %>% 
  ggplot() +
  geom_line(aes(x=timeBin, y=odbaGSum, group=ID,color=ID))+
  geom_line(data=meanlineWI,aes(x=timeBin, y=meanODBA),color="black",size=1.5) +
  ylim(0,800) +
  labs(x="Solar Hour",
       y = "Total ODBA (g)",
       title = "Austral winter total ODBA per solar hour") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PodbaSum24Wi
Podba24Seas <- ggarrange(PodbaSum24Su,PodbaSum24Wi,nrow=2)
Podba24Seas
# Save a file at 300 ppi
ggsave(Podba24Seas, file="Seasonal total ODBA per solar hour.png",width=12, height=6, dpi=300)

# Mean odba per solar hour by season
PodbaMeanSu <- data_states %>%
  filter(season == "Summer") %>% #View
  group_by(ID,timeBin) %>%
  summarize(odbaGMean = mean(ODBA/9.81,na.rm = TRUE)) %>% 
  ggplot() +
  geom_line(aes(x=timeBin, y=odbaGMean, group=ID,color=ID)) +
  labs(x="Solar Hour",
       y = "Mean ODBA (g)",
       title = "Austral summer mean ODBA per solar hour") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
# PodbaMeanSu
PodbaMeanWi <- data_states %>%
  filter(season == "Winter") %>% #View
  group_by(ID, timeBin) %>%
  summarize(odbaGMean = mean(ODBA/9.81,na.rm = TRUE)) %>% 
  ggplot() +
  geom_line(aes(x=timeBin, y=odbaGMean, group=ID,color=ID)) +
  labs(x="Solar Hour",
       y = "Mean ODBA (g)",
       title = "Austral winter mean ODBA per solar hour") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
# PodbaMeanWi
PodbaMeanSeas <- ggarrange(PodbaMeanSu,PodbaMeanWi,nrow=2)
PodbaMeanSeas
# Save a file at 300 ppi
ggsave(PodbaMeanSeas, file="Seasonal mean ODBA per solar hour.png",width=12, height=6, dpi=300)
```

### Alternative plot to geom_line
```{r}
BPodbaSum24Su <- data_states %>%
  filter(season == "Summer") %>% #View
  group_by(ID, season, timeBin) %>%
  summarize(odbaGSum = sum(ODBA/9.81,na.rm = TRUE)) %>% 
  ggplot() +
  geom_boxplot(aes(x=timeBin, y=odbaGSum, group=timeBin),color="#F8766D",
               show.legend = FALSE) +
  ylim(0,800) +
  labs(x="Solar Hour",
       y = "Total ODBA (g)",
       title = "Summer total ODBA per solar hour") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
BPodbaSum24Su
BPodbaSum24Wi <- data_states %>%
  filter(season == "Winter") %>% #View
  group_by(ID, season, timeBin) %>%
  summarize(odbaGSum = sum(ODBA/9.81,na.rm = TRUE)) %>% 
  ggplot() +
  geom_boxplot(aes(x=timeBin, y=odbaGSum, group=timeBin),color="#619CFF",
               show.legend = FALSE)+
  ylim(0,800) +
  labs(x="Solar Hour",
       y = "Total ODBA (g)",
       title = "Winter total ODBA per solar hour") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
BPodbaSum24Wi
BPodba24Seas <- ggarrange(BPodbaSum24Su,BPodbaSum24Wi,nrow=2)
BPodba24Seas
# Save a file at 300 ppi
ggsave(BPodba24Seas, file="Boxplot Seasonal total ODBA per solar hour.png",width=12, height=6, dpi=300)
```


### Statistical test of differences in total odba per solar hour by season
```{r}
# Combined years
sumODBA <- data_states %>% 
  group_by(ID,season) %>% 
  summarize(sumODBA=sum(ODBA))

sumODBASU <- sumODBA %>% 
  filter(season == "Summer")
sumODBAWI <- sumODBA %>% 
  filter(season == "Winter") 
shapiro.test(sumODBASU$sumODBA)
shapiro.test(sumODBAWI$sumODBA)
test <- stats::t.test(sumODBASU$sumODBA,sumODBAWI$sumODBA)
test

# This needs work. I need to find mean and SD for total ODBA over 24 hours.
# Mean and SD of summer total ODBA per solar hour
sumODBASUmean <- mean(sumODBASU$sumODBA)
sumODBASUsd <- sd(sumODBASU$sumODBA)
# Mean and SD of winter total ODBA per solar hour
sumODBAWImean <- mean(sumODBAWI$sumODBA)
sumODBAWIsd <- sd(sumODBAWI$sumODBA)

summarySumODBA <- sumODBA %>% 
  group_by(season) %>% 
  summarize(mean(sumODBA),
            sd(sumODBA))
  

```

### Additional plots not yet made
```{r}

# Cumulative sum of odba per state per period by season
# Boxplot of sum of ODBA per state per period by season
# Boxplot of sum of ODBA per period by season
## Seasonal total ODBA per day and night?

PodbaNight <- stateODBA %>% 
  group_by(season,ID,dayNight) %>%
  summarize(odbaSum = sum(odba)) %>%
  ggplot() +
  geom_boxplot(aes(x = dayNight, y = odbaSum, 
                   color = season)) +
  labs(x="State",
       y = "Duration (hr)",
       title = "State Durations per Individual (Night)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PodbaNight
```

### Plot seasonal activity durations by hour to look at patterns
*This plots rest and active by solar hour
```{r}
# H0: There is no difference in variance in activity durations between seasons.
# H1: More variance in summer activity durations when many resources are available across space and time. There will be less variance in activity durations during winter. Animals are more tied to spatial and temporal resources in the winter.
# Plot summer daytime activity absolute duration by hour
PcountSUdhr <- stateBout %>% 
  group_by(season,ID,dayNight,timeBin,state) %>%
  summarize(stateCount=n()/60) %>%
  filter(season=="Summer",
         dayNight=="day") %>%
  ggplot() +
  geom_boxplot(aes(x = timeBin, y = stateCount, 
                   color = state)) +
  labs(x="Solar Hour of Day",
       y = "Duration (min)",
       title = "Summer daytime activity absolute duration by hour (n=12)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
# PcountSUdhr
# Plot winter daytime activity absolute duration by hour
PcountWIdhr <- stateBout %>% 
  group_by(season,ID,dayNight,timeBin,state) %>%
  summarize(stateCount=n()/60) %>%
  filter(season=="Winter",
         dayNight=="day") %>%
  ggplot() +
  geom_boxplot(aes(x = timeBin, y = stateCount, 
                   color = state)) +
  labs(x="Solar Hour of Day",
       y = "Duration (min)",
       title = "Winter daytime activity absolute duration by hour (n=12)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
# PcountWIdhr
PcountSeasdhr <- ggarrange(PcountSUdhr,PcountWIdhr,nrow=2)
PcountSeasdhr

# Plot summer nighttime activity absolute duration by hour
PcountSUnhr <- stateBout %>% 
  group_by(season,ID,dayNight,timeBin,state) %>%
  summarize(stateCount=n()/60) %>%
  filter(season=="Summer",
         dayNight=="night") %>%
  ggplot() +
  geom_boxplot(aes(x = timeBin, y = stateCount, 
                   color = state)) +
  labs(x="Solar Hour of Day",
       y = "Duration (min)",
       title = "Summer nighttime activity absolute duration by hour (n=12)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
# PcountSUnhr

# Plot winter nighttime activity absolute duration by hour
PcountWInhr <- stateBout %>% 
  group_by(season,ID,dayNight,timeBin,state) %>%
  summarize(stateCount=n()/60) %>%
  filter(season=="Winter",
         dayNight=="night") %>%
  ggplot() +
  geom_boxplot(aes(x = timeBin, y = stateCount, 
                   color = state)) +
  labs(x="Solar Hour of Day",
       y = "Duration (min)",
       title = "Winter nighttime activity absolute duration by hour (n=12)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
# PcountWInhr
PcountSeasnhr <- ggarrange(PcountSUnhr,PcountWInhr,nrow=2)
PcountSeasnhr
```

### Plot seasonal state absolute durations to look at patterns
*This plots rest and active by day and night
```{r}
# Plot summer daytime activity absolute duration
Pcountd <- stateBout %>% 
  group_by(season,ID,dayNight,state) %>%
  summarize(stateCount=n()/60/60) %>%
  filter(dayNight=="day") %>%
  ggplot() +
  geom_boxplot(aes(x = state, y = stateCount, 
                   color = season)) +
  labs(x="State",
       y = "Duration (hr)",
       title = "Daytime activity absolute duration (n=12)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
# Pcountd
# Plot nighttime activity absolute duration
Pcountn <- stateBout %>% 
  group_by(season,ID,dayNight,state) %>%
  summarize(stateCount=n()/60/60) %>%
  filter(dayNight=="night") %>%
  ggplot() +
  geom_boxplot(aes(x = state, y = stateCount, 
                   color = season)) +
  labs(x="State",
       y = "Duration (hr)",
       title = "Nighttime activity absolute duration (n=12)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
# Pcountn
Pcount <- ggarrange(Pcountd,Pcountn,nrow=2)
Pcount
```

### Plot seasonal daytime mean activity bouts by hour. 
```{r}
# Plot summer daytime mean activity bouts by hour
PboutSUd <- stateBoutSum %>% 
  group_by(season,ID,dayNight,state,hr) %>%
  summarize(mboutLength=mean(boutLength)) %>%
  ungroup %>% # Do I need to ungroup and regroup?
  group_by(season,ID,dayNight,hr,state,mboutLength) %>%
  filter(season=="Summer",
         dayNight=="day") %>% #if want to filter, add state_classif %in% c(3,4)
  ggplot() +
  geom_boxplot(aes(x = hr, y = mboutLength, 
                   color = state)) +
  labs(x="Hour of Day",
       y = "Bout Length (min)",
       title = "Summer daytime mean activity bout by hour") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PboutSUd

# Plot winter daytime mean activity bouts by hour
PboutWId <- stateBoutSum %>% 
  group_by(season,ID,dayNight,state,hr) %>%
  summarize(mboutLength=mean(boutLength)) %>%
  ungroup %>% # Do I need to ungroup and regroup?
  group_by(season,ID,dayNight,hr,state,mboutLength) %>%
  filter(season=="Winter",
         dayNight=="day") %>% #if want to filter, add state_classif %in% c(3,4)
  ggplot() +
  geom_boxplot(aes(x = hr, y = mboutLength, 
                   color = state)) +
  labs(x="Hour of Day",
       y = "Bout Length (min)",
       title = "Winter daytime mean activity bout by hour") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
# PboutWId
PboutSeasd <- ggarrange(PboutSUd,PboutWId,nrow=2)
PboutSeasd

# Plot summer nighttime mean activity bouts by hour
PboutSUn <- stateBoutSum %>% 
  group_by(season,ID,dayNight,state,hr) %>%
  summarize(mboutLength=mean(boutLength)) %>%
  ungroup %>% # Do I need to ungroup and regroup?
  group_by(season,ID,dayNight,hr,activity,mboutLength) %>%
  filter(season=="Summer",
         dayNight=="night") %>% #if want to filter, add state_classif %in% c(3,4)
  ggplot() +
  geom_boxplot(aes(x = hr, y = mboutLength, 
                   color = state)) +
  labs(x="Hour of Day",
       y = "Bout Length (min)",
       title = "Summer nighttime mean activity bout by hour") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
# PboutSUn

# Plot winter nighttime mean activity bouts by hour
PboutWIn <- stateBoutSum %>% 
  group_by(season,ID,dayNight,state,hr) %>%
  summarize(mboutLength=mean(boutLength)) %>%
  ungroup %>% # Do I need to ungroup and regroup?
  group_by(season,ID,dayNight,hr,state,mboutLength) %>%
  filter(season=="Winter",
         dayNight=="night") %>% #if want to filter, add state_classif %in% c(3,4)
  ggplot() +
  geom_boxplot(aes(x = hr, y = mboutLength, 
                   color = state)) +
  labs(x="Hour of Day",
       y = "Bout Length (min)",
       title = "Winter nighttime mean activity bout by hour") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
# PboutWIn

PboutSeasn <- ggarrange(PboutSUn,PboutWIn,nrow=2)
PboutSeasn
```
