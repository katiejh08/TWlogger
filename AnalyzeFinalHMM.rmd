---
title: "Analyze Final HMM"
author: "Katie Harrington"
date: "April 19, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Get Started
*This file takes ... and does ...

## Load libraries; set working directory and local time zone offset
```{r}
library(tidyverse)
library(dplyr)
library(maptools) # to calculate solarpos
library(stringr)
library(lubridate)
library(adehabitatLT)
#library(argosfilter)
library(geosphere)
library(ggpubr)
library(sp)
library(rgdal)
library(tibble)
library("rnaturalearth")
library("rnaturalearthdata")
library("sf")
library("ggspatial")
library(marmap)
library(mapdata)
library(metR)

setwd("~/Projects/R/TWlogger")
tzOffset <-"Etc/GMT+3"
```

# Pre Process Data
```{r}
# Load R workspace
load("~/Projects/R/TWlogger/data_with_states.RData")

# Combine list into one dataframe
data <-bind_rows(data_with_states)

# Create Spatial Points
data$long <- -60.09
data$lat <- -51.37

# Check dttz 
attr(data$dttz, "tzone") #Check tz
attr(data$dttz, "tzone") <- tzOffset

data$date <- as.Date(data$dttz, tz = tzOffset)

# Run the sunrise sunset script
source('SunriseSunsetTimes.r')

# Check for NAs
sapply(data, function(x) sum(is.na(x)))

# Determine Season (calculated from 2018 solstices and equinoxes)
data$yday <- yday(data$dttz)
data$season <- rep('NA')
#data[which(data$yday > 79 & data$yday <= 173),]$season <- 'Fall'
data[which(data$yday > 173 & data$yday <= 265),]$season <- 'Winter'
#data[which(data$yday > 265 & data$yday < 355),]$season <- 'Spring'
data[which(data$yday >= 355 | data$yday <= 79),]$season <- 'Summer'
data$season <- as.factor(data$season)

unique(data$season)
```

# Process Data

## Calculate State Proportions per 24hr cycle
*No longer running this script
```{r}
# # Calculate state proportions per 24 hour cycle
# stateSummaryIND24 <- data %>% 
#   group_by(season, ID) %>%
#   mutate(cycleLength = n()) %>% #View
#   ungroup %>% 
#   group_by(season, ID, state_classif,cycleLength) %>% 
#   summarize(stateCountCycle = n()) %>% 
#   mutate(statePropCycle = stateCountCycle/cycleLength) %>% 
#   ungroup
# stateSummaryIND24$season_state <- paste(stateSummaryIND24$season,
#                                         stateSummaryIND24$state_classif,sep="_")
```

## Plot state proportions per 24hr cycle
*No longer running this script
```{r}
Pcycle <- stateSummaryIND24 %>% 
  group_by(season) %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = statePropCycle, group = season_state, color = season)) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (24hr Cycle)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pcycle
```

## Calculate state proportions per individual by astronomical period
*No longer creating these plots because Dawn+Day+Dusk have been combined
```{r}
# Calculate state proportions with 4 periods (dawn, day, dusk, night)
stateSummaryIND <- data %>% 
  group_by(season, ID, astronomical) %>% 
  mutate(periodLength = n()) %>% 
  ungroup %>% 
  group_by(season, ID, astronomical, state_classif,periodLength) %>% 
  summarize(stateCount = n()) %>% 
  mutate(stateProp = stateCount/periodLength) %>% 
  ungroup
# Change classes for plotting
stateSummaryIND$ID <- as.factor(stateSummaryIND$ID)
stateSummaryIND$astronomical <- as.factor(stateSummaryIND$astronomical)
str(stateSummaryIND) # Check classes
# Create vectors to retain groupings for plots
stateSummaryIND$season_per_state <- paste(stateSummaryIND$season,
                                          stateSummaryIND$astronomical,
                                          stateSummaryIND$state_classif,sep="_")
stateSummaryIND$season_period <- paste(stateSummaryIND$season,
                                          stateSummaryIND$astronomical,sep="_")
```

## Calculate state proportions per individual by 2 periods (day+night)
```{r}
# Calculate state proportions with 2 periods (day and night)
stateSummaryIND2period <- data %>% 
  group_by(season, ID) %>% 
  mutate(dayNight = ifelse(astronomical %in% c("dawn","day","dusk"),"day","night")) %>%
  ungroup %>% 
  group_by(season, ID, dayNight) %>% 
  mutate(periodLength2 = n()) %>% 
  ungroup %>% 
  group_by(season, ID, dayNight, state_classif,periodLength2) %>% 
  summarize(stateCount2 = n()) %>% 
  mutate(stateCountMin = stateCount2/60,
         stateCountHour = stateCount2/60/60,
         stateProp2 = stateCount2/periodLength2) %>% 
  ungroup

# Create vectors to retain groupings for plots
stateSummaryIND2period$ID <- as.factor(stateSummaryIND2period$ID)
stateSummaryIND2period$dayNight <- as.factor(stateSummaryIND2period$dayNight)
stateSummaryIND2period$season_per_state <- paste(stateSummaryIND2period$season,
                                          stateSummaryIND2period$dayNight,
                                          stateSummaryIND2period$state_classif,sep="_")
stateSummaryIND2period$season_period <- paste(stateSummaryIND2period$season,
                                       stateSummaryIND2period$dayNight,sep="_")
```

## Plot State Proportions per individual by astronomical period
*This creates stacked plots by Dawn, Day, Dusk, and Night
*No longer creating these plots because Dawn+Day+Dusk have been combined
```{r}
# Plot dawn
Pdawn <- stateSummaryIND %>% 
  group_by(season,astronomical) %>% 
  filter(astronomical == "dawn") %>% #View
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateProp, 
                   group = season_per_state, color = season)) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (Dawn)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pdawn
# Plot day
Pday <- stateSummaryIND %>% 
  group_by(season,astronomical) %>% 
  filter(astronomical == "day") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateProp, 
                   group = season_per_state, color = season)) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (Day)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pday
# Plot dusk
Pdusk <- stateSummaryIND %>% 
  group_by(season,astronomical) %>% 
  filter(astronomical == "dusk") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateProp, 
                   group = season_per_state, color = season)) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (Dusk)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pdusk
# Plot night
Pnight <- stateSummaryIND %>% 
  group_by(season,astronomical) %>% 
  filter(astronomical == "night") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateProp, 
                   group = season_per_state, color = season)) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (Night)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pnight

# Stack plots to compare full cycle
PallPeriods <- ggarrange(Pdawn,Pday,Pdusk,Pnight,nrow=2,ncol=2)
PallPeriods

# Save a file at 300 ppi
ggsave(PallPeriods, file="Seasonal State Proportions by Period.png",width=12, height=6, dpi=300)
```

## Plot State Proportions by Combined Periods
*This creates stacked plots by Day and Night
```{r}
# Plot combined day
Pday2 <- stateSummaryIND2period %>% 
  group_by(season,dayNight) %>% 
  filter(dayNight == "day") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateProp2, 
                   group = season_per_state, color = season)) +
  ylim(0,1) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (Dawn to Dusk)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pday2
# Plot night
Pnight2 <- stateSummaryIND2period %>% 
  group_by(season,dayNight) %>% 
  filter(dayNight == "night") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateProp2, 
                   group = season_per_state, color = season)) +
  ylim(0,1) +
  labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions (Night)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
Pnight2

# Stack plots to compare full cycle
P2Periods <- ggarrange(Pday2,Pnight2,nrow=2)
P2Periods

# Save a file at 300 ppi
ggsave(P2Periods, file="Seasonal State Proportions by Two Periods.png",width=12, height=6, dpi=300)
```

## Plot Absolute State Durations by Combined Periods
*This creates stacked plots per day and night of absolute duration and state proportion
```{r}
# Plot combined day
PdayDur <- stateSummaryIND2period %>%# View
  group_by(season,dayNight) %>% 
  filter(dayNight == "day") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateCountHour, 
                   group = season_per_state, color = season)) +
  ylim(0,15) +
  labs(x="State",
       y = "Duration (hr)",
       title = "State Durations per Individual (Dawn to Dusk)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PdayDur
# Plot night
PnightDur <- stateSummaryIND2period %>% #View
  group_by(season,dayNight) %>% 
  filter(dayNight == "night") %>% 
  ggplot() +
  geom_boxplot(aes(x = state_classif, y = stateCountHour, 
                   group = season_per_state, color = season)) +
  ylim(0,15) +
  labs(x="State",
       y = "Duration (hr)",
       title = "State Durations per Individual (Night)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PnightDur

# Stack plots to compare full cycle
PcycleDur <- ggarrange(PdayDur,PnightDur,nrow=2)
PcycleDur

# Save a file at 300 ppi
ggsave(PcycleDur, file="Seasonal State Durations by Two Periods.png",width=8, height=8, dpi=300)


# Stack plots to compare full cycle of state proportion and absolute duration
PpropDur <-ggarrange(PdayDur,PnightDur,Pday2,Pnight2,nrow=2,ncol=2)
PpropDur
# Save a file at 300 ppi
ggsave(PpropDur, file="Compare State Proportion and Duration.png",width=12, height=6, dpi=300)

```

## Compare state proportions and absolute durations per period
```{r}
# Test for difference in state duration between summer and winter day
# This subsets by day/night and filters for season, day, and state 4.
seasdiffdur1 <- stateSummaryIND2period %>% 
  subset(.,select = c(season,dayNight,state_classif,stateCountHour)) %>%
  filter(dayNight == "day",
         season == "Winter",
         state_classif == "4")
  # spread(season,stateCountHour)
seasdiffdur1$stateCountHourWI <- seasdiffdur1$stateCountHour
seasdiffdur1$stateCountHour <- NULL
seasdiffdur2 <- stateSummaryIND2period %>% 
  subset(.,select = c(season,dayNight,state_classif,stateCountHour)) %>%
  filter(dayNight == "day",
         season == "Summer",
         state_classif == "4")
  # spread(season,stateCountHour) 
seasdiffdur2$stateCountHourSU <- seasdiffdur2$stateCountHour
seasdiffdur2$stateCountHour <- NULL
shapiro.test(seasdiffdur1$stateCountHourWI)
shapiro.test(seasdiffdur2$stateCountHourSU)
test <- stats::t.test(seasdiffdur1$stateCountHourWI,seasdiffdur2$stateCountHourSU)
test

seasdiffdurState4 <- cbind(seasdiffdur1$stateCountHourWI,seasdiffdur2$stateCountHourSU)
colnames(seasdiffdurState4) <- c("stateCountHourWI", "stateCountHourSU")
write_csv(as.data.frame(seasdiffdurState4),file.path(getwd(),"state4duration.csv"))
```


# Add ODBA and raw acc data to state classifications dataframe
```{r}
# rename data while we import ODBA (also called data)
stateData <- data
# load Final Metrics (ODBA)
load("~/Projects/R/TWlogger/FinalMetrics.RData")
# Add acc data to stateData
stateODBA <- left_join(stateData,dplyr::select(data,ID,dttz,Ax,Ay,Az,odba, jerk), by = c("ID","dttz"))
stateODBA <- stateODBA %>% 
  group_by(season, ID) %>% 
  mutate(dayNight = ifelse(astronomical %in% c("dawn","day","dusk"),"day","night")) %>%
  ungroup
# Check for NAs
sapply(stateODBA, function(x) sum(is.na(x)))

# Create SolarMidnight based hourly bins
stateODBA$solarMidnight <- hms::as.hms((stateODBA$solarnoon- dhours(12)),tz = tzOffset)
stateODBA$time <- hms::as.hms(stateODBA$dttz,tz = tzOffset)
stateODBA$timeBin <- floor(as.numeric(difftime(stateODBA$time, stateODBA$solarMidnight,units = "hours")))
stateODBA$timeBin <- ifelse(stateODBA$timeBin < 0,stateODBA$timeBin+24,stateODBA$timeBin)
stateODBA$hr <- hour(data$dttz)
stateODBA$odbaG <- stateODBA$odba/9.81

# save.image()
# save(stateODBA,file="stateODBA.RData")
```

## Plot ODBA
```{r}
# Plots to assess rhythmicity and seasonality of behavior?
Podba24su <- stateODBA %>%
  filter(season == "Summer") %>% #View
  group_by(ID, hr) %>%
  summarize(odbaGSum = sum(odbaG,na.rm = TRUE),
            amagSum = sum(Amag_rollmean_2,na.rm = TRUE)) %>% 
  ggplot() +
  geom_line(aes(x=hr, y=odbaGSum, group=ID,color=ID))
Podba24su

Podba24wi <- stateODBA %>%
  filter(season == "Winter") %>% #View
  group_by(ID, timeBin) %>%
  summarize(odbaSum = sum(odba,na.rm = TRUE)) %>% 
  ggplot() +
  geom_line(aes(x=timeBin, y=odbaSum, group=ID,color=ID))
Podba24wi

#stateODBA %>% filter(ID == "Z55",timeBin == 14 ) %>% View


Podba24test <- stateODBA %>%
  filter(season == "Summer") %>% #View
  ggplot() +
  geom_line(aes(x=time, y=Amag, group=ID,color=ID))
Podba24test
# Cumulative sum of odba per state per period by season

# Boxplot of sum of ODBA per state per period by season

# Boxplot of sum of ODBA per period by season
PodbaNight <- stateODBA %>% 
  group_by(season,ID,dayNight) %>%
  summarize(odbaSum = sum(odba)) %>%
  ggplot() +
  geom_boxplot(aes(x = dayNight, y = odbaSum, 
                   color = season)) +
  labs(x="State",
       y = "Duration (hr)",
       title = "State Durations per Individual (Night)") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
PodbaNight

testODBA <- stateODBA %>% 
  filter(ID == "X36",
         hr == 10) %>% 
  ggplot() +
  geom_line(aes(x=dttz,y=odbaG)) +
  labs(x="Time",
       y = "ODBA (g)",
       title = "X36 ODBA") + 
  theme_classic(base_size = 13) + 
  theme(plot.title = element_text(size=14)) +
  theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))
testODBA
```

## Calculate duration per state bout
```{r}
stateBout <- stateODBA %>% 
  group_by(season,ID) %>% 
  arrange(dttz) %>%
  mutate(boutNum = cumsum(replace_na(lag(state_classif) != state_classif, 1))) %>%
  ungroup %>% 
  group_by(season,ID,boutNum) %>% 
  mutate(boutLength = n()/60) %>% #bout length is in minutes
  ungroup
stateBout$state_classif <- as.factor(stateBout$state_classif)
# Plot state bout histogram
stateBoutSum <- stateBout %>%
  group_by(season,ID,boutNum,state_classif) %>%
  summarize(boutLength=first(boutLength)) 
stateBoutSum %>% 
  filter(ID=="M62") %>% #if want to filter, add state_classif %in% c(3,4)
  ggplot() +
  geom_freqpoly(aes(boutLength, group=state_classif,color=state_classif),bins=100)
  # geom_histogram(aes(boutLength, group=state_classif,color=state_classif),bins=100)

```


## Need to identify purpose of these plots
```{r}
# Plot
stateSummaryIND %>% 
  group_by(season,astronomical) %>% 
  ggplot() +
    geom_boxplot(aes(x = season_per_state, y = stateProp, 
                   group = season_per_state, color = season_period)) +
    labs(x="State",
       y = "Proportion (%)",
       title = "State Proportions") + 
    theme_classic(base_size = 13) + 
    theme(plot.title = element_text(size=14)) +
    theme(axis.text = element_text(size = 14, color = "black"),
        axis.title.x = element_text(color="black", size=14),
        axis.title.y = element_text(color="black", size=14))

# I forget what this following plot is used for:
# stateSummary <- stateSummaryIND %>% 
#   group_by(season, astronomical, state_classif) %>% 
#   summarize(groupMeanProp = mean(stateProp))
# 
# ggplot() +
#   geom_col(data = stateSummary,
#                aes(x = astronomical, y = groupMeanProp, group = state_classif)) +
#   labs(x="State",
#        y = "Proportion (%)",
#        title = "State Proportions") + 
#   theme_classic(base_size = 13) + 
#   theme(plot.title = element_text(size=14)) +
#   theme(axis.text = element_text(size = 14, color = "black"),
#         axis.title.x = element_text(color="black", size=14),
#         axis.title.y = element_text(color="black", size=14))
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
